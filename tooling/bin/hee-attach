#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<USAGE
hee-attach

Attaches HEE policy to a repo locally without committing doctrine into the repo.

Usage:
  tooling/bin/hee-attach --target <repo_path> [--hee <hee_repo_path>]

Effect:
  - Creates .hee/policy/{prompts,docs} inside target repo (local-only)
  - Syncs HEE prompts into .cursor/prompts (local-only)
  - Adds .hee/ and .cursor/ to local exclude suggestions (prints commands)
USAGE
}

TARGET=""
HEE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --target) TARGET="$2"; shift 2;;
    --hee) HEE="$2"; shift 2;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown arg: $1"; usage; exit 1;;
  esac
done

[[ -n "$TARGET" ]] || { usage; exit 1; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_HEE="$(cd "$SCRIPT_DIR/../.." && pwd)"
HEE="${HEE:-$DEFAULT_HEE}"

[[ -d "$TARGET/.git" ]] || { echo "ERROR: target not a git repo: $TARGET"; exit 1; }
[[ -d "$HEE/.git" ]] || { echo "ERROR: HEE not a git repo: $HEE"; exit 1; }

mkdir -p "$TARGET/.hee/policy/prompts" "$TARGET/.hee/policy/docs" "$TARGET/.cursor/prompts"

rsync -a --delete --exclude ".cursor/" "$HEE/prompts/" "$TARGET/.hee/policy/prompts/"
rsync -a --delete "$HEE/docs/" "$TARGET/.hee/policy/docs/"

# Sync into Cursor convenience
rsync -a --delete \
  --exclude "docs/" \
  --exclude ".cursor/" \
  "$TARGET/.hee/policy/prompts/" "$TARGET/.cursor/prompts/"

cat <<TXT
OK: attached HEE policy locally to:
  $TARGET/.hee/policy
and synced Cursor prompts to:
  $TARGET/.cursor/prompts

Suggested ignores (choose one):
  1) Local-only (recommended for shared repos):
     echo ".hee/" >> $TARGET/.git/info/exclude
     echo ".cursor/" >> $TARGET/.git/info/exclude

  2) Repo-wide .gitignore (if you want everyone to ignore these):
     echo ".hee/" >> $TARGET/.gitignore
     echo ".cursor/" >> $TARGET/.gitignore
TXT
