#!/usr/bin/env python3
import os, sys, subprocess, argparse, tempfile

def die(msg, code=2):
    print(f"ERROR: {msg}", file=sys.stderr)
    sys.exit(code)

def read_patch(args):
    # precedence: --file > --patch > stdin > VAR/env
    if args.file:
        with open(args.file, "rb") as f:
            return f.read(), f"--file:{args.file}"

    if args.patch:
        return args.patch.encode(), "--patch"

    if not sys.stdin.isatty():
        data = sys.stdin.buffer.read()
        if data.strip():
            return data, "stdin"

    var = os.environ.get("VAR", "")
    if var:
        s = var.strip()
        if "diff --git" in var:
            return var.encode(), "env:VAR"
        if var in os.environ:
            return os.environ[var].encode(), f"env:VAR->{var}"
        # Convenience: allow VAR to point directly at a patch file path.
        if s and os.path.exists(s):
            with open(s, "rb") as f:
                return f.read(), f"env:VAR->file:{s}"
        return var.encode(), "env:VAR"

    die("no patch input found")

def normalize(b):
    b = b.replace(b"\r\n", b"\n")
    if b.startswith(b"\xef\xbb\xbf"):
        b = b[3:]
    b = b.lstrip();
    if b and not b.endswith(b"\n"):
        b += b"\n"
    return b

def main():
    ap = argparse.ArgumentParser(
        epilog=("INPUT PRECEDENCE:\n"
                "  1) --file PATH\n"
                "  2) --patch TEXT\n"
                "  3) stdin (non-TTY, non-empty)\n"
                "  4) env VAR: if contains diff --git => patch text; else treat as indirection name\n"\
                "VALIDATION:\n"
                "  - normalizes CRLF->LF, strips BOM, trims leading whitespace\n"
                "  - ensures trailing newline\n"
                "  - hard-fails unless patch starts with: diff --git\n"\
                "APPLY:\n"
                "  - default uses: git apply\n"
                "  - --check uses: git apply --check\n"
                "  - --index (if used) stages via git apply --index\n"),
        formatter_class=argparse.RawTextHelpFormatter
    )
    ap.add_argument("--file")
    ap.add_argument("--patch")
    ap.add_argument("--check", action="store_true")
    ap.add_argument("--index", action="store_true")
    ap.add_argument("--debug", action="store_true")
    ap.add_argument("--selftest", action="store_true")
    args = ap.parse_args()

    if args.selftest:
        return selftest()

    raw, src = read_patch(args)

    raw = normalize(raw)

    if not raw.startswith(b"diff --git"):
        die("patch must start with 'diff --git'")

    if args.debug:
        print(f"[debug] source={src} bytes={len(raw)}", file=sys.stderr)

    cmd = ["git", "apply"]
    if args.index:
        cmd.append("--index")
    if args.check:
        cmd.append("--check")

    p = subprocess.run(cmd + ["-"], input=raw)
    sys.exit(p.returncode)

def selftest():
    base = os.path.join(os.path.dirname(__file__), "patch-apply-fixtures")
    ok = 0
    for name in os.listdir(base):
        p = os.path.join(base, name)
        rc = subprocess.call(
            [sys.executable, __file__, "--file", p, "--check"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        )
        if name.startswith("ok-") and rc == 0:
            ok += 1
        elif name.startswith("bad-") and rc != 0:
            ok += 1
    print(f"selftest passed={ok}")
    return 0

if __name__ == "__main__":
    main()
