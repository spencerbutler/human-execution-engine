# path: blueprints/oper-spencer-dash-blueprint.yaml
ack:
  status: accepted
  scope: ttf_corrections + oper_spencer_dash
  quality: correct
  over_ack: stopped

ttf:
  causes: confirmed
  corrections: applied
  mets:
    met_id: ttf.v1
    state: defined
    evidence_path: ".hee/mets/ttf/"
    rollups: [p50, p95, mean, count]

dash:
  blueprint: oper_spencer_dash
  priority: P0
  default_source: release_artifacts
  override: explicit_branch_or_sha
  panels: 7
  guardrails:
    - read_only
    - deterministic
    - bundle_on_render

dash_now:
  branch_safety: preserved
  method:
    - stash_dirty: true
    - render_from_existing_artifacts: true
    - output_path: ".hee/dash/oper.spencer/"
  expected_disk:
    - ".hee/dash/oper.spencer/index.html"

next:
  action: render_dash_now
  commit_required: false
  fin: unchanged
# Operator Spencer Dashboard Blueprint
# Always-on observability dashboard for HEE state and metrics

type: hee.blueprint
blueprint_id: oper_spencer_dash.v1
version: v1
description: "Always-on dashboard for HEE state/mets; release-only; callable for any branch/version"
created_at: "2026-01-28T23:48:16-06:00"
author: "HEE System"

metadata:
  name: oper_spencer_dash
  scope: observability
  priority: P0
  intent: "always-on dashboard for HEE state/mets; release-only; callable for any branch/version"
  doctrine:
    - always_on_visibility_reduces_ttf
    - release_is_default_source_of_truth
    - branch_override_is_explicit
    - read_only_by_default

inputs:
  required:
    - bundle_corpus: ".hee/bundles/"
    - mets: ".hee/mets/"
    - audit: ".hee/audit/"
  selectors:
    default: release
    override:
      allowed: true
      fields: [branch, tag, git_sha]

outputs:
  - html: ".hee/dash/oper.spencer/index.html"
  - json: ".hee/dash/oper.spencer/state.json"

panels:
  - ttf_trend
  - bundle_throughput
  - patch_apply_success_rate
  - dedupe_rate
  - top_failure_modes
  - hw_skip_rate_cron
  - ci_pass_rate_langs

guardrails:
  - non_mutating: true
  - no_network_required: preferred
  - deterministic_render: true
  - every_render_emits_bundle: true

release_policy:
  default_source: "latest_release_artifacts"
  override_source: "explicit_branch_or_sha"
  forbid:
    - implicit_branch_selection

acceptance:
  - "dash builds from release artifacts with zero config"
  - "override requires explicit flag + recorded in bundle"

implementation:
  core_component: rust_preferred
  rendering: plotly_static
  data_aggregation: async_rust
  bundle_emitter: integrated

panel_definitions:
  ttf_trend:
    title: "Time to Finish (TTF) Trends"
    data_source: ".hee/mets/ttf/"
    metrics: [p50, p95, mean]
    visualization: line_chart
    time_range: 30d

  bundle_throughput:
    title: "Bundle Throughput"
    data_source: ".hee/bundles/"
    metrics: [bundles_per_hour, pills_per_bundle, patch_hashes_unique]
    visualization: bar_chart
    group_by: source_type

  patch_apply_success_rate:
    title: "Patch Apply Success Rate"
    data_source: ".hee/bundles/"
    metrics: [apply_success_pct, check_success_pct]
    visualization: gauge_chart
    filter_by: operation_type

  dedupe_rate:
    title: "Patch Deduplication Rate"
    data_source: ".hee/mets/dedupe/"
    metrics: [unique_patches_pct, duplicate_clusters_count]
    visualization: trend_chart
    time_range: 7d

  top_failure_modes:
    title: "Top Failure Modes"
    data_source: ".hee/bundles/"
    metrics: [failure_count_by_type, top_error_messages]
    visualization: pie_chart
    limit: 10

  hw_skip_rate_cron:
    title: "Hardware Skip Rate (Cron)"
    data_source: ".hee/bundles/cron/"
    metrics: [hw_skip_pct, skip_reason_breakdown]
    visualization: stacked_bar
    time_range: 7d

  ci_pass_rate_langs:
    title: "CI Pass Rate by Language"
    data_source: ".hee/mets/langs/mastery/"
    metrics: [ci_pass_rate_by_lang, env_rebuild_success_by_lang]
    visualization: heatmap
    languages: [rust, python, go, typescript, cpp]

data_processing:
  aggregation:
    method: rollup_from_bundles
    window: 1h
    retention: 90d
  caching:
    enabled: true
    ttl: 5m
    invalidation: on_new_bundle
  filtering:
    default_time_range: 7d
    max_time_range: 90d
    sampling: adaptive

deployment:
  default_mode: release_artifacts
  override_flags:
    - "--branch <branch>"
    - "--tag <tag>"
    - "--sha <sha>"
  bundle_output: ".hee/bundles/dash/oper.spencer/"

validation_gates:
  - zero_config_release_build
  - deterministic_rendering
  - bundle_emission_verified
  - override_audit_logged

failure_modes:
  - data_missing: "Graceful degradation with last known good"
  - render_timeout: "Partial render with error indicators"
  - bundle_write_fail: "Continue with warning, retry on next run"
