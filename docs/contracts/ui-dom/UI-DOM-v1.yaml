schema: hee/contracts/ui-dom/v1
id: UI-DOM-v1
status: draft
owner: oper-spencer
purpose: >
  Detect and contain Chat UI degradation and ghost writer drift.
  Preserve operator momentum by enforcing monitoring, early stop options,
  evidence emission, and rapid handoff to a fresh chat.

policy:
  canonical_order:
    - yaml
    - md
  canonical_rule: >
    YAML is canonical. MD is derived. Any contract that involves UI-DOM must
    adhere to this policy and link to immutable evidence on disk.
  future_path:
    - yaml
    - yaml.sqz
    - yaml.sqz9
  no_contractions: true
  ordering:
    unordered_list_policy: >
      Unordered lists are footguns. Convert unordered lists to ordered lists
      when an order exists. If order is unclear, do one roll squeeze to produce
      a best effort order. If steps exist, steps must be ordered.

scope:
  applies_to_ordered:
    - dric_contracts_that_reference_ui_dom
    - any_chat_session_with_ui_degradation_risk
    - any_evidence_workflow_that_generates_large_pasteables
  out_of_scope_ordered:
    - design_relay_governance_rules_not_related_to_ui_dom
    - repository_ci_rules_unrelated_to_ui_stability

signals_ordered:
  - key: latency_skew
    label: thinking_time_to_output_skew
    description: oper perceives thinking time versus output start latency is skewed
    weight: 1

  - key: quality_decline_gradual
    label: gradual_output_decline
    description: oper observes a gradual decline in output quality or coherence
    weight: 1

  - key: stalling_exponential
    label: stalling_growth
    description: oper observes output stalling that increases in severity over time
    weight: 2

  - key: ui_white_square
    label: send_button_white_square_or_freeze
    description: >
      oper observes freeze screen and no visible progress.
      UI is assumed to be outputting.
      Buttons show no state change.
      Send icon may become a white square and only stop is available.
      Keyboard enter triggers the current indicator.
    weight: 3

  - key: copy_button_no_ack
    label: copy_code_button_no_ack
    description: >
      oper observes the copy code button does not acknowledge quickly.
      This degrades with other UI signals.
      oper loses confidence that clipboard contents are correct.
      new oper is likely to footgun by assuming copy succeeded.
    weight: 2

  - key: ghost_write_flying_blind
    label: ghost_write_flying_blind
    description: >
      oper observes ghost write state where input box does not display typed text.
      oper is flying blind. Nothing remains visible in the input box.
      In later stages, text may appear briefly, then freeze again.
      oper may continue typing during the freeze state.
    weight: 3

  - key: ghost_writer_present
    label: ghost_writer_detected
    description: oper observes ghost writer behavior
    weight: 2

  - key: ghost_writer_battle
    label: prolonged_ghost_writer_battle
    description: oper battles ghost writer across multiple attempts
    weight: 3

  - key: output_incomplete_or_rambling
    label: output_drift
    description: output drifts into long ghost writing and scope bleed
    weight: 2

ghost_write:
  definition: >
    Ghost write is true when oper keyboard input is accepted, but the input box does not
    display typed text. Oper is flying blind. Nothing remains visible in the input box.
    In later stages, text may appear briefly, then freeze again. Oper may continue typing.

  indicators_ordered:
    - key: keyboard_inputs_work
      description: oper types and the UI accepts keystrokes
    - key: input_box_shows_no_text
      description: input box shows no visible typed text during entry
    - key: intermittent_text_then_freeze
      description: text may appear briefly, then freeze again

  operator_risk: >
    Oper loses visibility into what was typed. Copy and paste confidence collapses.
    This can silently corrupt evidence and tool usage. This can also mask UI manipulation.


typing_and_typos:
  policy: >
    Oper input may contain typos during UI degradation and ghost write sessions.
    Assistant must correct typos with best guess without expanding scope.
    Assistant must keep diffs minimal.
    DOM may manipulate key input during ghost write session and this is an attack vector.
    If first correction attempt fails, squeeze roll again and keep diffs minimal.

  rationale: >
    Tracking typos helps detect DOM corruption patterns and supports debugging.
  rules_ordered:
    - do_not_repeat_typos_in_pasteables
    - apply_best_guess_corrections
    - keep_output_diffs_minimal
    - preserve_operator_intent

scoring:
  total: sum_weights
  bands_ordered:
    - name: continue
      min: 0
      max: 2
      required_action: continue_work
    - name: finish_scope_then_stop
      min: 3
      max: 5
      required_action: finish_current_scope_item_then_stop
    - name: stop_now
      min: 6
      max: 999
      required_action: stop_immediately_emit_evidence_and_spawn_new_chat

monitoring:
  enabled: true
  measure_output_threshold: 1
  measure_output_policy: >
    Output measurement when measurement is greater than zero.
    Output again on every measurement increment event.
    Tune frequency later.

  measure_line_format: "ui_dom:score_total=N ui_dom:signals=CSV"
  measure_output_on_increment: true
  aggregate_math_policy: >
    When producing aggregate measurements, output math and include a cost benefit view.
    ABCBA applies. Always be cost benefit analysis applies.

mandates_ordered:
  - id: always_be_cost_savings
    rule: >
      Always reduce cost of interaction.
      Avoid large paste blocks before, during, and after work steps.
      Prefer file based artifacts and small outputs.
      Prefer clipboard transfer when available.

  - id: beat_ghost_writer
    rule: >
      Finish scoped work before the session degrades into ghost writing.
      Use scoring bands to force early stop and clean handoff.

  - id: no_contractions_in_contract_artifacts
    rule: >
      Contracts and DRIC directed pasteables must not use contractions.
      This reduces unbalanced quote risk.

clipboard:
  policy: prefer_when_available
  selection: first_available
  ordered_preference_enabled_when:
    - multiple_buffers_supported
    - tool_emits_metrics
    - tool_enables_additional_hee_behavior
  ordered_preference_best_effort:
    - xsel
    - xclip
    - wl-copy
    - pbcopy
    - clip.exe
  status_line_requirement: true
  status_lines_ordered:
    - clipboard:copied=TOOL
    - clipboard:failed=TOOL
    - clipboard:unavailable
  note: >
    Clipboard usage reduces paste risk and helps avoid UI degradation.
    Clipboard non acknowledgement is a UI-DOM signal.

evidence:
  requirement: mandatory
  immutable_path_rule: >
    Evidence must be written to an immutable path on disk.
    Victory declarations must occur in evidence only.
  write_on_paste_requirement: true
  wrote_tag: "WROTE:"
  mechanism: >
    mdshell must source repo wrapper functions.
    Wrapper must write evidence to disk and print WROTE line.
    Clipboard helper must print a final clipboard status line.
  fields_kv_ordered:
    - ui_dom_timestamp_chat_begin
    - ui_dom_timestamp_first_output
    - ui_dom_measure_total
    - ui_dom_signals_observed
    - ui_dom_action_taken
    - ui_dom_evidence_path
    - ui_dom_commit_hash
    - ui_dom_next_chat_pointer

artifacts:
  requirement: mandatory
  keys_ordered:
    - art.disk
    - art.gh
    - art.hee
  placeholder_policy:
    unknown_placeholder: art.disk.unknown
  examples:
    art.disk: "hee/evidence/ui-dom/E20260202T000000Z-ui-dom.txt"
    art.gh: "gh-raw-url-unknown"
    art.hee: "hee://contracts/ui-dom/UI-DOM-v1"

actions:
  continue_work:
    steps_ordered: true
    steps:
      - keep_outputs_small
      - prefer_file_based_artifacts
      - avoid_large_paste_blocks
      - prefer_clipboard_transfer_when_available
      - maintain_branch_guard
      - maintain_evidence

  finish_current_scope_item_then_stop:
    steps_ordered: true
    steps:
      - produce_next_chat_pill
      - notify_operator_of_ui_dom_state
      - finish_only_current_scope_item
      - emit_immutable_evidence_pointer
      - spawn_new_chat

  stop_immediately_emit_evidence_and_spawn_new_chat:
    steps_ordered: true
    steps:
      - produce_next_chat_pill
      - notify_operator_of_ui_dom_state
      - stop_output_now
      - emit_immutable_evidence_pointer
      - spawn_new_chat

handoff:
  requirement: mandatory_when_action_is_finish_scope_then_stop_or_stop_now
  pill_format:
    header_lines_ordered:
      - "Chat: UI-DOM-Continuation"
      - "Purpose: Continue work with preserved momentum and small outputs"
      - "Artifacts: art.disk.unknown"
    include_ordered:
      - current_branch
      - current_goal
      - last_good_commit
      - next_mechanical_steps
      - evidence_pointer
      - ui_dom_kv

ghost_write_progress:
  goal: >
    Provide visible progress markers during ghost write to preserve momentum.
  operator_practice_modes_ordered:
    - typing_sharpening
    - short_term_memory_sharpening
    - focus_sharpening
    - vent_channeling_into_structure
    - per_turn_improvement_visibility
  metrics_ordered:
    - typo_corrections_count
    - typo_correction_squeeze_roll_count
    - gw_lines_emitted
    - gw_turn_count
    - ui_dom_measure_total
    - ui_dom_measure_increments
    - time_to_first_output_seconds_estimate
  note: >
    Oper may use newline separated increments as a manual progress bar.

oper_name_skills:
  - key: ghost_writer_egg_discovery
    label: ghost_writer_egg_found
    description: >
      oper reports: I found the ghost writer egg and it was painful.
      oper questions why the ui dom duct tape bug persists.
      This is a signal for logging and escalation, not a workflow step.

stop_policy:
  note: >
    There is no immediate rush to stop a chat during dogfood.
    The goal is to reduce time spent in work chats.
    Oper may spawn a new chat for freeform discussion.

notes:
  hee_petrol: momentum preservation is primary
  easter_egg: >
    There is an easter egg about riding ghost writer.
    Record it in evidence when discovered.
    Do not publish discovery steps.
