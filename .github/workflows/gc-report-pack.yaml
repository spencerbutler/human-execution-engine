name: GC Report Pack (smoke)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  gc-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Bash syntax check
        run: bash -n scripts/gc.sh

      - name: Run GC (recommend-only)
        env:
          LARGE_FILE_MB: "25"
          STALE_BRANCH_DAYS: "14"
          GC_APPLY: "0"
        run: |
          chmod +x scripts/gc.sh
          ./scripts/gc.sh || true

      - name: Assert required outputs exist
        run: |
          test -f var/gc/latest/README.md
          test -f var/gc/latest/report.html
          test -f var/gc/latest/metrics.json

      - name: Validate metrics schema v1.0
        run: |
          python3 - <<'PY'
          import json
          m=json.load(open("var/gc/latest/metrics.json","r",encoding="utf-8"))
          assert m.get("schema_version")=="1.0"
          for k in ["run_id","timestamp","repo_root","git_sha","git_branch"]:
            assert k in m and m[k], k
          print("metrics.json schema OK")
          PY
