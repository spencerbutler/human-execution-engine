name: HEE Security Scanning

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  MODEL: claude-3-5-sonnet-20250929

jobs:
  security-scan:
    name: Comprehensive Security Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run HEE Security Scanner
      run: |
        echo "üîç Running HEE security scanner..."

        # Check for security scanner script
        if [ -f "scripts/security_scanner.py" ]; then
          echo "‚úÖ Security scanner found at scripts/security_scanner.py"
          # Note: Would execute the actual security scanner here
          # python scripts/security_scanner.py
        else
          echo "‚ö†Ô∏è  Security scanner not found, running basic security checks"
        fi

    - name: Check for sensitive information
      run: |
        echo "üîç Scanning for sensitive information..."

        # Check for hardcoded secrets
        echo "Checking for potential secrets..."
        if grep -r "password\|secret\|key\|token" --include="*.md" --include="*.py" --include="*.js" --include="*.json" --include="*.env*" . | grep -v "docs/doctrine/HEE_POLICY.md" | grep -v "prompts/PROMPTING_RULES.md" | grep -v "test\|example\|demo\|sample" | head -10; then
          echo "‚ö†Ô∏è  Potential sensitive information found:"
          grep -r "password\|secret\|key\|token" --include="*.md" --include="*.py" --include="*.js" --include="*.json" --include="*.env*" . | grep -v "docs/doctrine/HEE_POLICY.md" | grep -v "prompts/PROMPTING_RULES.md" | grep -v "test\|example\|demo\|sample" | head -10
        else
          echo "‚úÖ No obvious sensitive information detected"
        fi

    - name: Check for security policy compliance
      run: |
        echo "üîç Validating security policy compliance..."

        # Check for security policy
        if [ -f "docs/doctrine/SECURITY.md" ]; then
          echo "‚úÖ Security policy found"
        else
          echo "‚ö†Ô∏è  Security policy missing"
        fi

        # Check for HEE policy security sections
        if [ -f "docs/doctrine/HEE_POLICY.md" ] && grep -q "security" docs/doctrine/HEE_POLICY.md; then
          echo "‚úÖ HEE policy includes security sections"
        else
          echo "‚ö†Ô∏è  HEE policy security sections may be missing"
        fi

    - name: Check for dependency vulnerabilities
      run: |
        echo "üîç Checking for dependency vulnerabilities..."

        # Check for package.json
        if [ -f "package.json" ]; then
          echo "‚úÖ Found package.json, would run npm audit here"
          # npm audit --audit-level=moderate
        fi

        # Check for requirements.txt
        if [ -f "requirements.txt" ]; then
          echo "‚úÖ Found requirements.txt, would run pip-audit here"
          # pip-audit --requirement requirements.txt
        fi

        # Check for Cargo.toml
        if [ -f "Cargo.toml" ]; then
          echo "‚úÖ Found Cargo.toml, would run cargo audit here"
          # cargo audit
        fi

    - name: Check for insecure patterns
      run: |
        echo "üîç Checking for insecure patterns..."

        # Check for eval usage
        if grep -r "eval(" --include="*.py" --include="*.js" .; then
          echo "‚ö†Ô∏è  Found eval() usage - review for security implications"
        else
          echo "‚úÖ No eval() usage detected"
        fi

        # Check for shell injection patterns
        if grep -r "os\.system\|subprocess\.call\|exec\(" --include="*.py" .; then
          echo "‚ö†Ô∏è  Found potential shell injection patterns - review for security"
        else
          echo "‚úÖ No obvious shell injection patterns detected"
        fi

    - name: Check for HEE-specific security compliance
      run: |
        echo "üîç Checking HEE-specific security compliance..."

        # Check for model disclosure in commits
        if git --no-pager log --oneline -20 | grep -q "\[model:"; then
          echo "‚úÖ Model disclosure found in recent commits"
        else
          echo "‚ö†Ô∏è  No model disclosure found in recent commits"
        fi

        # Check for pager prevention compliance
        if [ -f "docs/doctrine/HEE_POLICY.md" ] && grep -q "pager prevention" docs/doctrine/HEE_POLICY.md; then
          echo "‚úÖ Pager prevention policy documented"
        else
          echo "‚ùå Pager prevention policy missing"
        fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'python' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog OSS (push)
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --only-verified

      - name: Run TruffleHog OSS (pull_request)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified
