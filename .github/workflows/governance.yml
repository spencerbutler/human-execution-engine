name: HEE Governance Testing CI

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  lint-checker:
    name: Lint Governance Checker
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Lint governance checker
      run: |
        echo "üîç Running governance-aware linting..."

        # Ensure shellcheck is available
        if ! command -v shellcheck &> /dev/null; then
          echo "Installing shellcheck..."
          sudo apt-get update && sudo apt-get install -y shellcheck
        fi

        # Lint the main checker script
        shellcheck ci/governance/check.sh

        # Enforce governance hygiene
        echo "üîç Checking governance hygiene..."

        # Ensure set -euo pipefail is used
        if ! grep -q "set -euo pipefail" ci/governance/check.sh; then
          echo "‚ùå check.sh must use 'set -euo pipefail'"
          exit 1
        fi

        # Ensure single entrypoint (no arbitrary sourcing)
        if grep -o "source.*\.sh" ci/governance/check.sh | grep -v "rules.sh" | grep -q .; then
          echo "‚ùå check.sh must not source arbitrary files (only rules.sh)"
          exit 1
        fi

        # Ensure rules.sh is only sourced from check.sh
        if ! grep -q "source.*rules.sh" ci/governance/check.sh; then
          echo "‚ùå check.sh must source rules.sh"
          exit 1
        fi

        echo "‚úÖ Governance checker linting passed"

  governance-real:
    name: Test Against Real Repository
    needs: lint-checker
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run governance check on repository
      run: |
        echo "üîç Running governance check against real repository..."
        bash ci/governance/check.sh --path .

  governance-fixtures:
    name: Test Governance Fixtures
    needs: lint-checker
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test ok-minimal fixture (should pass)
      run: |
        echo "üîç Testing fixture: ok-minimal (expected: PASS)"
        output=$(bash ci/governance/check.sh --path governance/fixtures/ok-minimal 2>&1)
        exit_code=$?
        echo "Exit code: $exit_code"
        echo "Output: $output"
        if [ $exit_code -ne 0 ]; then
          echo "‚ùå Expected ok-minimal to pass, but got exit $exit_code"
          exit 1
        fi
        echo "‚úÖ ok-minimal fixture validation passed"

    - name: Test bad-missing-prompts fixture (should fail with GOV-STRUCT-001)
      run: |
        echo "üîç Testing fixture: bad-missing-prompts (expected: FAIL with GOV-STRUCT-001)"
        output=$(./ci/governance/check.sh --path governance/fixtures/bad-missing-prompts 2>&1)
        exit_code=$?
        echo "Exit code: $exit_code"
        echo "Output length: ${#output}"
        echo "Output content:"
        echo "$output" | cat -A
        if [ $exit_code -ne 1 ]; then
          echo "‚ùå Expected bad-missing-prompts to fail, but got exit $exit_code"
          exit 1
        fi
        if ! echo "$output" | grep -q "GOV-STRUCT-001"; then
          echo "‚ùå Expected GOV-STRUCT-001 violation not found in output"
          exit 1
        fi
        echo "‚úÖ bad-missing-prompts fixture validation passed"

    - name: Test bad-missing-doctrine-doc fixture (should fail with GOV-STRUCT-001, GOV-DOC-001)
      run: |
        echo "üîç Testing fixture: bad-missing-doctrine-doc (expected: FAIL with GOV-STRUCT-001, GOV-DOC-001)"
        output=$(bash ci/governance/check.sh --path governance/fixtures/bad-missing-doctrine-doc 2>&1)
        exit_code=$?
        echo "Exit code: $exit_code"
        echo "Output: $output"
        if [ $exit_code -ne 1 ]; then
          echo "‚ùå Expected bad-missing-doctrine-doc to fail, but got exit $exit_code"
          exit 1
        fi
        if ! echo "$output" | grep -q "GOV-STRUCT-001:"; then
          echo "‚ùå Expected GOV-STRUCT-001 violation not found"
          exit 1
        fi
        if ! echo "$output" | grep -q "GOV-DOC-001:"; then
          echo "‚ùå Expected GOV-DOC-001 violation not found"
          exit 1
        fi
        echo "‚úÖ bad-missing-doctrine-doc fixture validation passed"

    - name: Test bad-prompt-missing-authority fixture (should fail with GOV-PROMPT-001)
      run: |
        echo "üîç Testing fixture: bad-prompt-missing-authority (expected: FAIL with GOV-PROMPT-001)"
        output=$(bash ci/governance/check.sh --path governance/fixtures/bad-prompt-missing-authority 2>&1)
        exit_code=$?
        echo "Exit code: $exit_code"
        echo "Output: $output"
        if [ $exit_code -ne 1 ]; then
          echo "‚ùå Expected bad-prompt-missing-authority to fail, but got exit $exit_code"
          exit 1
        fi
        if ! echo "$output" | grep -q "GOV-PROMPT-001:"; then
          echo "‚ùå Expected GOV-PROMPT-001 violation not found"
          exit 1
        fi
        echo "‚úÖ bad-prompt-missing-authority fixture validation passed"

  hello-world-execution:
    name: HEE Hello World Execution
    needs: governance-fixtures
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run hello world workload
        shell: bash
        run: ./workloads/hello-world/run.sh
