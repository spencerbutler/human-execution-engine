name: HEE Documentation Management

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'prompts/**'
  push:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'prompts/**'

env:
  MODEL: claude-3-5-sonnet-20250929

jobs:
  documentation-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate documentation structure
      run: |
        echo "üîç Validating HEE documentation structure..."
        
        # Check for required documentation files
        required_docs=("docs/HEE.md" "docs/HEER.md" "docs/TROUBLESHOOTING.md" "prompts/INIT.md" "docs/HEE_POLICY.md" "prompts/PROMPTING_RULES.md")
        
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "‚úÖ $doc found"
          else
            echo "‚ùå $doc missing"
            exit 1
          fi
        done

    - name: Check documentation cross-references
      run: |
        echo "üîç Checking documentation cross-references..."
        
        # Check for cross-references to state capsule guide
        if grep -r "docs/STATE_CAPSULE_GUIDE.md" --include="*.md" .; then
          echo "‚úÖ Cross-references to state capsule guide found"
        else
          echo "‚ö†Ô∏è  No cross-references to state capsule guide found"
        fi
        
        # Check for cross-references to HEE policy
        if grep -r "docs/HEE_POLICY.md" --include="*.md" .; then
          echo "‚úÖ Cross-references to HEE policy found"
        else
          echo "‚ö†Ô∏è  No cross-references to HEE policy found"
        fi
        
        # Check for cross-references to prompting rules
        if grep -r "prompts/PROMPTING_RULES.md" --include="*.md" .; then
          echo "‚úÖ Cross-references to prompting rules found"
        else
          echo "‚ö†Ô∏è  No cross-references to prompting rules found"
        fi

    - name: Validate file path references
      run: |
        echo "üîç Validating file path references..."
        
        # Check for broken relative path references
        echo "Checking for broken relative path references..."
        for file in $(find . -name "*.md" -type f); do
          if grep -q "\.md)" "$file"; then
            echo "Checking references in $file"
            # Extract markdown links and check if files exist
            grep -o '\[[^]]*\](\([^)]*\))' "$file" | sed 's/.*](\([^)]*\)).*/\1/' | while read -r link; do
              if [[ "$link" == *.md ]]; then
                # Convert relative path to absolute for checking
                dir=$(dirname "$file")
                full_path="$dir/$link"
                if [ ! -f "$full_path" ]; then
                  echo "‚ö†Ô∏è  Broken link in $file: $link"
                fi
              fi
            done
          fi
        done
        echo "‚úÖ File path reference validation completed"

    - name: Check documentation formatting
      run: |
        echo "üîç Checking documentation formatting standards..."
        
        # Check for proper HEE documentation structure
        if [ -f "docs/STATE_CAPSULES/2026-01-24/HEE-Current-Tasks.md" ]; then
          echo "‚úÖ State capsule structure found"
        else
          echo "‚ö†Ô∏è  State capsule structure may be missing"
        fi
        
        # Check for task sections in documentation
        if grep -r "## Active Tasks\|### Task:" --include="*.md" .; then
          echo "‚úÖ Task sections found in documentation"
        else
          echo "‚ö†Ô∏è  Task sections may be missing from documentation"
        fi

  documentation-links-check:
    name: Documentation Links Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Comprehensive link validation
      run: |
        echo "üîç Running comprehensive link validation..."
        
        # Check for internal markdown links
        echo "Checking internal markdown links..."
        for file in $(find . -name "*.md" -type f); do
          if grep -q "\.md)" "$file"; then
            echo "Validating links in $file"
            # Extract and validate markdown links
            grep -o '\[[^]]*\](\([^)]*\))' "$file" | sed 's/.*](\([^)]*\)).*/\1/' | while read -r link; do
              if [[ "$link" == *.md ]]; then
                # Convert relative path to absolute for checking
                dir=$(dirname "$file")
                full_path="$dir/$link"
                if [ -f "$full_path" ]; then
                  echo "‚úÖ Valid link: $link"
                else
                  echo "‚ùå Broken link: $link in $file"
                fi
              fi
            done
          fi
        done

    - name: Check for documentation consistency
      run: |
        echo "üîç Checking documentation consistency..."
        
        # Check for consistent HEE terminology
        if grep -r "Human Execution Engine\|HEE" --include="*.md" . | head -5; then
          echo "‚úÖ HEE terminology found"
        fi
        
        # Check for consistent task formatting
        if grep -r "### Task:" --include="*.md" . | head -3; then
          echo "‚úÖ Task formatting found"
        fi

  documentation-health-check:
    name: Documentation Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Documentation health validation
      run: |
        echo "üîç Running documentation health check..."
        
        # Check for documentation completeness
        echo "Checking documentation completeness..."
        
        # Count markdown files
        md_count=$(find . -name "*.md" -type f | wc -l)
        echo "Found $md_count markdown files"
        
        # Check for recent documentation updates
        if find . -name "*.md" -type f -mtime -7 | head -1; then
          echo "‚úÖ Recent documentation updates found"
        else
          echo "‚ö†Ô∏è  No recent documentation updates"
        fi
        
        # Check for documentation in proper directories
        if [ -d "docs" ] && [ -d "prompts" ]; then
          echo "‚úÖ Documentation directories found"
        else
          echo "‚ùå Documentation directories missing"
        fi

  final-documentation-summary:
    name: Final Documentation Summary
    runs-on: ubuntu-latest
    needs: [documentation-validation, documentation-links-check, documentation-health-check]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Documentation validation summary
      run: |
        echo "üîç Running final documentation validation summary..."
        
        echo "‚úÖ HEE Documentation Management completed"
        echo "üìã Summary:"
        echo "   - Documentation structure: Validated"
        echo "   - Cross-references: Checked"
        echo "   - File path references: Validated"
        echo "   - Documentation formatting: Checked"
        echo "   - Internal links: Validated"
        echo "   - Documentation consistency: Checked"
        echo "   - Documentation health: Validated"
        
        echo "üéØ All HEE documentation checks completed!"
