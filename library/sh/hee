#!/bin/sh
set -eu

realpath_hee() {
  # prefer coreutils; fallback to python
  if command -v readlink >/dev/null 2>&1; then
    p="$(readlink -f -- "$0" 2>/dev/null || true)"
    [ -n "${p:-}" ] && { echo "$p"; return 0; }
  fi
  if command -v python3 >/dev/null 2>&1; then
    python3 - <<'PY'
import os, sys
print(os.path.realpath(sys.argv[1]))
PY
    return 0
  fi
  # worst-case: raw
  echo "$0"
}

HEE_REAL="$(realpath_hee)"
SELF_DIR="$(CDPATH= cd -- "$(dirname -- "$HEE_REAL")" && pwd -P)"

usage() {
  cat <<'TXT'
hee

USAGE:
  hee help
  hee ls
  hee version | --version
  hee print <path|->                # hee-print
  hee fileident <path|->            # hee-fileident
  hee pathcheck <cmd>               # hee-pathcheck
  hee http404 [opts] <access.log>   # hee-http404
  hee pathwin <path> [path...]          # hee-pathwin

  hee uiboss <args...>              # pass-through to uiboss (except serve)
  hee serve [--bind IP] [--port N]  # serve UIBOSS_DOCROOT; fallback if hee_webserver missing

NOTES:
  - Runtime truth is the installed toolset next to this hee binary.
TXT
}

if [ "${1-}" = "--help" ] || [ "${1-}" = "-h" ] || [ "${1-}" = "help" ] || [ $# -eq 0 ]; then
  usage
  exit 0
fi

# alias
if [ "${1-}" = "--version" ]; then
  set -- version
fi

sub="$1"
shift

case "$sub" in
  ls)
    echo "subcommands:"
    echo "  help"
    echo "  ls"
    echo "  version"
    echo "  print"
    echo "  fileident"
    echo "  pathcheck"
    echo "  http404"
    echo "  uiboss"
    echo "  serve"
    exit 0
    ;;

  version)
    VFILE="$SELF_DIR/hee.version"
    echo "hee:"
    echo "  path: \"$(command -v hee 2>/dev/null || echo "$HEE_REAL")\""
    echo "  realpath: \"$HEE_REAL\""
    if command -v sha256sum >/dev/null 2>&1; then
      echo "  sha256: \"$(sha256sum "$HEE_REAL" | awk '{print $1}')\""
    else
      echo "  sha256: \"(sha256sum missing)\""
    fi
    echo "  toolset_dir: \"$SELF_DIR\""
    echo "  tool_lang: \"sh\""
    if command -v file >/dev/null 2>&1; then
      echo "  file: \"$(file -b "$HEE_REAL" | sed 's/"/'\''/g')\""
    fi

    echo "  toolset:"
    for t in hee hee-print hee-fileident hee-pathcheck hee-http404; do
      p="$SELF_DIR/$t"
      if [ -x "$p" ]; then
        if command -v sha256sum >/dev/null 2>&1; then
          h="$(sha256sum "$p" | awk '{print $1}')"
        else
          h="(sha256sum missing)"
        fi
        echo "    - name: \"$t\""
        echo "      path: \"$p\""
        echo "      sha256: \"$h\""
      fi
    done

    if [ -f "$VFILE" ]; then
      echo "  version_file: \"$VFILE\""
      echo "  version:"
      sed 's/^/    /' "$VFILE"
    else
      echo "  version_file: \"(none)\""
    fi
    exit 0
    ;;

  print)      exec "$SELF_DIR/hee-print" "$@";;
  fileident)  exec "$SELF_DIR/hee-fileident" "$@";;
  pathcheck)  exec "$SELF_DIR/hee-pathcheck" "$@";;
  http404)    exec "$SELF_DIR/hee-http404" "$@";;

  uiboss)
    if [ "${1-}" = "serve" ]; then
      shift || true
      exec "$0" serve "$@"
    fi
    exec uiboss "$@"
    ;;

  serve)
    BIND="127.0.0.1"
    PORT="7777"
    while [ $# -gt 0 ]; do
      case "$1" in
        --bind) BIND="${2-}"; shift 2;;
        --port) PORT="${2-}"; shift 2;;
        -h|--help) usage; exit 0;;
        *) break;;
      esac
    done

    DOCROOT="${UIBOSS_DOCROOT:-${UIBOSS_SITE_ROOT:-$HOME/.hee/uiboss/site}}"
    LOG="$DOCROOT/server.access.log"
    mkdir -p "$DOCROOT"

    if python3 - <<PY >/dev/null 2>&1
import socket
s=socket.socket()
s.settimeout(0.2)
try:
  s.connect(("${BIND}", int("${PORT}")))
  raise SystemExit(0)
except Exception:
  raise SystemExit(2)
finally:
  try: s.close()
  except Exception: pass
PY
    then
      echo "ðŸŸ¦ serve: already listening (expected) bind=$BIND port=$PORT url=http://$BIND:$PORT/" | tee -a "$LOG" >&2
      exit 3
    fi

    if python3 - <<'PY' >/dev/null 2>&1
import importlib.util
raise SystemExit(0 if importlib.util.find_spec("hee_webserver") else 2)
PY
    then
      exec uiboss serve --bind "$BIND" --port "$PORT"
    fi

    echo "ðŸŸ  hee serve: hee_webserver missing; fallback to python3 -m http.server (bind=$BIND port=$PORT docroot=$DOCROOT)" \
      | tee -a "$LOG" >&2
    exec python3 -m http.server "$PORT" --bind "$BIND" --directory "$DOCROOT" 2>&1 | tee -a "$LOG"
    ;;
  pathwin)
    shift
    exec hee-pathwin ""
    ;;


  *)
    echo "ðŸ”´ unknown subcommand: $sub" >&2
    usage >&2
    exit 2
    ;;
esac
