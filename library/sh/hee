#!/bin/sh
set -eu

# determinism: always dispatch to sibling tools next to this script
SELF_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)"

usage() {
  cat <<'TXT'
hee

USAGE:
  hee help
  hee ls
  hee version
  hee print <path|->                # hee-print
  hee fileident <path|->            # hee-fileident
  hee pathcheck <cmd>               # hee-pathcheck
  hee http404 [opts] <access.log>   # hee-http404

  hee uiboss <args...>              # pass-through to uiboss (except serve)
  hee serve [--bind IP] [--port N]  # serve UIBOSS_DOCROOT; fallback if hee_webserver missing

NOTES:
  - Runtime truth is the installed toolset next to this hee binary.
  - Installed prefix is typically ~/.hee/bin (but can be repo-local during test-drive).
TXT
}

if [ "${1-}" = "--help" ] || [ "${1-}" = "-h" ] || [ "${1-}" = "help" ] || [ $# -eq 0 ]; then
  usage
  exit 0
fi

sub="$1"
shift

case "$sub" in
  ls)
    echo "subcommands:"
    echo "  help"
    echo "  ls"
    echo "  version"
    echo "  print"
    echo "  fileident"
    echo "  pathcheck"
    echo "  http404"
    echo "  uiboss"
    echo "  serve"
    exit 0
    ;;

  version)
    HEE_PATH="$(command -v hee 2>/dev/null || true)"
    VFILE="$SELF_DIR/hee.version"
    echo "hee:"
    echo "  path: \"${HEE_PATH:-$SELF_DIR/hee}\""
    if command -v sha256sum >/dev/null 2>&1; then
      echo "  sha256: \"$(sha256sum "$SELF_DIR/hee" | awk '{print $1}')\""
    else
      echo "  sha256: \"(sha256sum missing)\""
    fi
    echo "  toolset_dir: \"$SELF_DIR\""
    if [ -f "$VFILE" ]; then
      echo "  version_file: \"$VFILE\""
      echo "  version:"
      sed 's/^/    /' "$VFILE"
    else
      echo "  version_file: \"(none)\""
    fi
    exit 0
    ;;

  print)      exec "$SELF_DIR/hee-print" "$@";;
  fileident)  exec "$SELF_DIR/hee-fileident" "$@";;
  pathcheck)  exec "$SELF_DIR/hee-pathcheck" "$@";;
  http404)    exec "$SELF_DIR/hee-http404" "$@";;

  uiboss)
    # determinism: uiboss serve must inherit hee serve fallback + port-preflight
    if [ "${1-}" = "serve" ]; then
      shift || true
      exec "$0" serve "$@"
    fi
    exec uiboss "$@"
    ;;

  serve)
    BIND="127.0.0.1"
    PORT="7777"
    while [ $# -gt 0 ]; do
      case "$1" in
        --bind) BIND="${2-}"; shift 2;;
        --port) PORT="${2-}"; shift 2;;
        -h|--help) usage; exit 0;;
        *) break;;
      esac
    done

    DOCROOT="${UIBOSS_DOCROOT:-${UIBOSS_SITE_ROOT:-$HOME/.hee/uiboss/site}}"
    LOG="$DOCROOT/server.access.log"
    mkdir -p "$DOCROOT"

    # preflight: if already listening, mark expected + rc=3
    if python3 - <<PY >/dev/null 2>&1
import socket
s=socket.socket()
s.settimeout(0.2)
try:
  s.connect(("${BIND}", int("${PORT}")))
  raise SystemExit(0)
except Exception:
  raise SystemExit(2)
finally:
  try: s.close()
  except Exception: pass
PY
    then
      echo "ðŸŸ¦ serve: already listening (expected) bind=$BIND port=$PORT url=http://$BIND:$PORT/" | tee -a "$LOG" >&2
      exit 3
    fi

    if python3 - <<'PY' >/dev/null 2>&1
import importlib.util
raise SystemExit(0 if importlib.util.find_spec("hee_webserver") else 2)
PY
    then
      exec uiboss serve --bind "$BIND" --port "$PORT"
    fi

    echo "ðŸŸ  hee serve: hee_webserver missing; fallback to python3 -m http.server (bind=$BIND port=$PORT docroot=$DOCROOT)" \
      | tee -a "$LOG" >&2
    exec python3 -m http.server "$PORT" --bind "$BIND" --directory "$DOCROOT" 2>&1 | tee -a "$LOG"
    ;;

  *)
    echo "ðŸ”´ unknown subcommand: $sub" >&2
    usage >&2
    exit 2
    ;;
esac
