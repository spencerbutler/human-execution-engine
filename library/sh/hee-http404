#!/bin/sh
set -eu

usage() {
  echo "hee-http404"
  echo
  echo "USAGE:"
  echo "  hee-http404 [opts] <access.log>"
  echo
  echo "OPTS:"
  echo "  -q, --quiet        machine-friendly (top list only)"
  echo "  -v, --verbose      show raw 404 request lines (uniq; tail window)"
  echo "      --top-only     only show top paths"
  echo "      --top N        top N paths (default 25)"
  echo "      --tail N       tail window for recent uniq / verbose (default 200)"
}

QUIET=0
VERBOSE=0
TOP_ONLY=0
TOP_N=25
TAIL_N=200
LOG=""

# opts-anywhere parsing: we accept switches in any position; one non-flag arg is LOG.
while [ $# -gt 0 ]; do
  case "$1" in
    -q|--quiet) QUIET=1; shift; continue;;
    -v|--verbose) VERBOSE=1; shift; continue;;
    --top-only) TOP_ONLY=1; shift; continue;;
    --top) TOP_N="${2-}"; shift 2; continue;;
    --tail) TAIL_N="${2-}"; shift 2; continue;;
    -h|--help) usage; exit 0;;
    --) shift; break;;
    -*)
      echo "error: unknown opt: $1" >&2
      usage >&2
      exit 2
      ;;
    *)
      if [ -z "$LOG" ]; then
        LOG="$1"
        shift
        continue
      fi
      echo "error: extra arg (expected only one log): $1" >&2
      exit 2
      ;;
  esac
done

# If '--' was used, remaining args must contain exactly one LOG.
if [ $# -gt 0 ]; then
  if [ -z "$LOG" ] && [ $# -eq 1 ]; then
    LOG="$1"
    shift
  fi
fi

if [ -z "$LOG" ]; then usage; exit 2; fi
test -f "$LOG"

extract_404_paths() {
  rg -F '" ' "$LOG" \
  | awk '
      /" 404 / {
        if (match($0, /"[^ ]+ ([^ ]+) HTTP/, m)) { print m[1] }
      }'
}

top_404() {
  extract_404_paths | sort | uniq -c | sort -nr | head -n "$TOP_N"
}

recent_uniq_404() {
  rg -F '" ' "$LOG" | tail -n "$TAIL_N" \
  | awk '
      /" 404 / {
        if (match($0, /"[^ ]+ ([^ ]+) HTTP/, m)) { print m[1] }
      }' \
  | sort | uniq
}

last_fallback() {
  rg -F "hee serve:" "$LOG" | tail -n 1 || true
}

TOP="$(top_404 || true)"

if [ "$QUIET" -eq 1 ]; then
  echo "$TOP" | awk '{c=$1; $1=""; sub(/^ /,""); print c " " $0}'
  exit 0
fi

echo "ðŸŸ¦ log: $LOG"

FB="$(last_fallback)"
if [ -n "$FB" ]; then
  echo "ðŸŸ  serve fallback (last)"
  echo "$FB"
fi

echo "ðŸŸ¦ top 404 paths (top $TOP_N)"
if [ -n "$TOP" ]; then echo "$TOP"; else echo "ðŸŸ¢ none"; fi

if [ "$TOP_ONLY" -eq 0 ]; then
  echo "ðŸŸ¦ recent uniq 404 paths (tail $TAIL_N request lines)"
  recent_uniq_404 | sed -n '1,200p'
fi

if [ "$VERBOSE" -eq 1 ]; then
  echo "ðŸŸ¦ verbose raw 404 request lines (uniq; tail $TAIL_N)"
  rg -F '" 404 ' "$LOG" | tail -n "$TAIL_N" | sort -u | sed -n '1,120p' || true
fi
