#!/bin/sh
set -eu

usage() {
  echo "hee-http404"
  echo
  echo "USAGE:"
  echo "  hee-http404 [opts] <access.log>"
  echo
  echo "OPTS:"
  echo "  -q, --quiet        machine-friendly (top list only)"
  echo "  -v, --verbose      show raw recent 404 log lines (spammy)"
  echo "      --top-only     only show top paths"
  echo "      --top N        top N paths (default 25)"
  echo "      --tail N       consider last N request lines for recent uniq (default 200)"
}

QUIET=0
VERBOSE=0
TOP_ONLY=0
TOP_N=25
TAIL_N=200

while [ $# -gt 0 ]; do
  case "$1" in
    -q|--quiet) QUIET=1; shift;;
    -v|--verbose) VERBOSE=1; shift;;
    --top-only) TOP_ONLY=1; shift;;
    --top) TOP_N="${2-}"; shift 2;;
    --tail) TAIL_N="${2-}"; shift 2;;
    -h|--help) usage; exit 0;;
    --) shift; break;;
    -*) echo "error: unknown opt: $1" >&2; usage; exit 2;;
    *) break;;
  esac
done

if [ $# -ne 1 ]; then usage; exit 2; fi
LOG="$1"
test -f "$LOG"

rg_f() { rg -F "$1" "$LOG"; }

# Extract 404 paths from request lines (GET/HEAD/POST...); fixed-string filter first.
extract_404_paths() {
  rg -F '" ' "$LOG" \
  | awk '
      /" 404 / {
        if (match($0, /"[^ ]+ ([^ ]+) HTTP/, m)) { print m[1] }
      }'
}

top_404() {
  extract_404_paths \
    | sort | uniq -c | sort -nr | head -n "$TOP_N"
}

recent_uniq_404() {
  # only consider tail window of request lines to reduce noise
  rg -F '" ' "$LOG" | tail -n "$TAIL_N" \
  | awk '
      /" 404 / {
        if (match($0, /"[^ ]+ ([^ ]+) HTTP/, m)) { print m[1] }
      }' \
  | sort | uniq
}

if [ "$QUIET" -eq 0 ]; then
  echo "ðŸŸ¦ log: $LOG"
fi

# Top offenders is the main signal.
TOP="$(top_404 || true)"

if [ "$QUIET" -eq 1 ]; then
  # machine-friendly: "<count> <path>"
  echo "$TOP" | awk '{c=$1; $1=""; sub(/^ /,""); print c " " $0}'
  exit 0
fi

echo "ðŸŸ¦ top 404 paths (top $TOP_N)"
if [ -n "$TOP" ]; then
  echo "$TOP"
else
  echo "ðŸŸ  none"
fi

if [ "$TOP_ONLY" -eq 0 ]; then
  echo "ðŸŸ¦ recent uniq 404 paths (tail $TAIL_N request lines)"
  recent_uniq_404 | sed -n '1,200p'
fi

if [ "$VERBOSE" -eq 1 ]; then
  echo "ðŸŸ¦ verbose raw 404 lines (tail 50; spam)"
  rg_f 'code 404' | tail -n 50 || true
  rg_f '" 404 '   | tail -n 50 || true
fi
