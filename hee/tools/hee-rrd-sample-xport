#!/bin/sh
# Export a small window from an RRD into a hee/v1 Measure metric.series YAML (stdout).
# Usage: hee-rrd-sample-xport /path/to/file.rrd [CF] [RRA_INDEX] [DS]
# Defaults: CF=AVERAGE RRA_INDEX=0 DS=1
set -u

RRD="${1:-}"
CF="${2:-AVERAGE}"
RRA_INDEX="${3:-0}"
DS="${4:-1}"

if [ -z "$RRD" ]; then
  echo "missing rrd path" >&2
  exit 1
fi
command -v rrdtool >/dev/null 2>&1 || { echo "rrdtool not found" >&2; exit 1; }

STEP="$(rrdtool info "$RRD" | awk -F' = ' '$1=="step"{gsub(/ /,"",$2);print $2;exit}')"
LAST="$(rrdtool info "$RRD" | awk -F' = ' '$1=="last_update"{gsub(/ /,"",$2);print $2;exit}')"
[ -n "$STEP" ] || STEP=60
[ -n "$LAST" ] || LAST=0

END="$LAST"
if [ "$STEP" -gt 0 ] && [ "$LAST" -gt 0 ]; then
  END=$(( LAST - (LAST % STEP) ))
fi
START=$(( END - (STEP * 10) ))

LAST_RFC="$(date -u -d "@$LAST" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || echo null)"
START_RFC="$(date -u -d "@$START" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || echo null)"
END_RFC="$(date -u -d "@$END" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || echo null)"

VALUES="$(
  rrdtool fetch "$RRD" "$CF" --start "$START" --end "$END" \
  | awk 'NF==2 && $1 ~ /^[0-9]+:/ { v=$2; if (v ~ /nan/i) print "null"; else print "\"" v "\"" }' \
  | paste -sd, -
)"

cat <<__YAML__
apiVersion: hee/v1
kind: Measure
metadata:
  name: rrd-series-sample
  description: "SAMPLE: metric.series exported from RRD"
  labels:
    hee.object: "true"
    hee.tcos/env: test
    hee.tcos/topic: ops
  annotations:
    hee.sample: "true"
    hee.sample.note: "stdout export; small window"
spec:
  measure: metric.series
  flow: { type: snapshot }
  ts:
    start: "$START_RFC"
    end: "$END_RFC"
    step_sec: $STEP
    last_update: "$LAST_RFC"
  context:
    rrd:
      file_ref: "$RRD"
      ds: "$DS"
      ds_type: "GAUGE"
      cf: "$CF"
      rra_index: $RRA_INDEX
      step_sec: $STEP
      resolution_sec: $STEP
  series:
    unit: null
    values_dec: [ $VALUES ]
__YAML__
