#!/bin/sh
# hee-measure-check: one-command loop runner
# - runs hee-measure-translate
# - prints translate/quarantine counts (from report)
# - runs hee-measure-gates across translated metric.series YAML
# - actionable messaging when there are no RRD inputs

set -eu

FAIL=0
DRY_RUN=0
IN_ROOT="${HOME}/.hee/in-take"
OUT_ROOT="${HOME}/.hee/out-take"

usage() {
  echo "usage: hee-measure-check [--fail] [--dry-run] [--in-root PATH] [--out-root PATH]" >&2
}

while [ $# -gt 0 ]; do
  case "$1" in
    --fail) FAIL=1; shift ;;
    --dry-run) DRY_RUN=1; shift ;;
    --in-root) IN_ROOT="${2:-}"; shift 2 ;;
    --out-root) OUT_ROOT="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

ME_TRANSLATE="$(dirname "$0")/hee-measure-translate"
ME_GATES="$(dirname "$0")/hee-measure-gates"

[ -x "$ME_TRANSLATE" ] || { echo "missing tool: $ME_TRANSLATE" >&2; exit 2; }
[ -x "$ME_GATES" ] || { echo "missing tool: $ME_GATES" >&2; exit 2; }

TS_UTC="$(date -u +%Y%m%dT%H%M%SZ)"
echo "游릱 ts_utc=$TS_UTC"
echo "游릱 in_root=$IN_ROOT"
echo "游릱 out_root=$OUT_ROOT"

# Count RRD inputs (pre-translate) to drive actionable messaging
RRD_IN_DIR="${IN_ROOT}/rrd"
RRD_IN_COUNT=0
if [ -d "$RRD_IN_DIR" ]; then
  # count *.rrd files only
  set +e
  RRD_IN_COUNT="$(ls -1 "$RRD_IN_DIR"/*.rrd 2>/dev/null | wc -l | tr -d " ")"
  set -e
fi

# 1) translate
if [ "$DRY_RUN" -eq 1 ]; then
  "$ME_TRANSLATE" --dry-run --in-root "$IN_ROOT" --out-root "$OUT_ROOT"
  exit 0
fi

TRANSLATE_OUT="$("$ME_TRANSLATE" --in-root "$IN_ROOT" --out-root "$OUT_ROOT" || true)"
echo "$TRANSLATE_OUT"

# Parse report path from translate output: "ok: report=/path"
REPORT="$(printf '%s\n' "$TRANSLATE_OUT" | awk -F'report=' '/^ok: report=/{print $2; exit}')"
if [ -n "${REPORT:-}" ] && [ -f "$REPORT" ]; then
  W_TRANSLATE="$(grep -c '^WRITE translate ' "$REPORT" 2>/dev/null || true)"
  W_QUARANTINE="$(grep -c '^WRITE quarantine ' "$REPORT" 2>/dev/null || true)"
  W_SKIP="$(grep -c '^SKIP ' "$REPORT" 2>/dev/null || true)"
  echo "游릱 translate_writes=$W_TRANSLATE quarantine_writes=$W_QUARANTINE skips=$W_SKIP report=$REPORT"
else
  echo "游리 report not found/parsed (ok in Q0)"
fi

# 2) gates over translated YAML (rrd/translate/metric.series/*.yaml)
SER_DIR="${OUT_ROOT}/rrd/translate/metric.series"

if [ ! -d "$SER_DIR" ]; then
  if [ "$RRD_IN_COUNT" -eq 0 ]; then
    echo "游리 no RRD inputs found (expected *.rrd): $RRD_IN_DIR"
    echo "游릱 skipping series gates (nothing to translate)"
    exit 0
  fi

  echo "游리 RRD inputs exist ($RRD_IN_COUNT) but no translated series dir: $SER_DIR"
  echo "游릱 check report above (translate/quarantine/skips) for root cause"
  if [ "$FAIL" -eq 1 ]; then
    exit 1
  fi
  exit 0
fi

# Collect files (avoid glob failure)
set +e
FILES="$(ls -1 "$SER_DIR"/*.yaml 2>/dev/null)"
set -e

if [ -z "$FILES" ]; then
  if [ "$RRD_IN_COUNT" -eq 0 ]; then
    echo "游리 no RRD inputs found (expected *.rrd): $RRD_IN_DIR"
    echo "游릱 no metric.series yaml expected"
    exit 0
  fi

  echo "游리 translated series dir exists but contains no YAML: $SER_DIR"
  if [ "$FAIL" -eq 1 ]; then
    exit 1
  fi
  exit 0
fi

echo "# GATES (summary)"
TOTAL=0
FAILS=0

for f in $FILES; do
  TOTAL=$((TOTAL+1))
  if "$ME_GATES" --fail "$f" >/dev/null 2>&1; then
    :
  else
    FAILS=$((FAILS+1))
    echo "游댮 fail: $f"
    "$ME_GATES" "$f" | sed -n '1,12p'
  fi
done

echo "游릱 total_files=$TOTAL"
echo "游릱 gate_failures=$FAILS"

if [ "$FAIL" -eq 1 ] && [ "$FAILS" -gt 0 ]; then
  exit 1
fi

exit 0
